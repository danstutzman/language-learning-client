<html>
  <head>
  </head>
  <body>
    <h1>Hello world</h1>

    <div id='mount'>
      progress: <div id='progress'></div>
    </div>

    <script>
      function installServiceWorker() {
        navigator.serviceWorker.register('service-worker.js?' + Math.random())
            .then(function(reg) {
          window.alert('installing' + reg.installing)
          if (reg.installing === null) { // service-worker.js didn't change
            loadVendorScript();
          }
          // updatefound is fired if service-worker.js changes.
          reg.onupdatefound = function() {
            // The updatefound event implies that reg.installing is set; see
            // https://w3c.github.io/ServiceWorker/#service-worker-registration-updatefound-event
            var installingWorker = reg.installing;

            installingWorker.onstatechange = function() {
              switch (installingWorker.state) {
                case 'installed':
                  if (navigator.serviceWorker.controller) {
                    // At this point, the old content will have been purged
                    // and the fresh content will have been added to the
                    // cache.  It's the perfect time to display a "New
                    // content is available; please refresh." message in the
                    // page's interface.
                    window.alert('New or updated content is available.');
                  } else {
                    // At this point, everything has been precached.
                    loadVendorScript();
                  }
                  break;
                case 'redundant':
                  console.error(
                    'The installing service worker became redundant.');
                  break;
              }
            };
          };
        }).catch(function(e) {
          console.error('Error during service worker registration:', e);
        });
      }

      var scriptPaths = ['/js/vendor.js', '/js/browserified.js'];

      function loadVendorScript() {
        window.alert('load vendor');
        console.log('loadVendorScript')
        var s = document.createElement('script');
        s.setAttribute('src', scriptPaths[0]);
        s.setAttribute('onload', "loadBrowserifiedScript()")
        document.body.appendChild(s);
      }

      function loadBrowserifiedScript() {
        window.alert('load browserified');
        console.log('loadBrowserifiedScript')
        var s = document.createElement('script');
        s.setAttribute('src', scriptPaths[1]);
        document.body.appendChild(s);
      }

      function predownloadScripts() {
        var progresses = [0, 0];
        for (var i = 0; i < scriptPaths.length; i++) {
          var scriptPath = scriptPaths[i];
          (function(i) {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function(e) {
              if (xhr.readyState === XMLHttpRequest.DONE) {
                progresses[i] = 1;
                if (progresses[0] + progresses[1] === 2) {
                  installServiceWorker();
                }
              }
            };

            xhr.addEventListener('progress', function(e) {
              if (e.lengthComputable) {
                progresses[i] = e.loaded / e.total;
                document.getElementById('progress').innerHTML = Math.floor(
                  (progresses[0] + progresses[1]) * 100 / 2);
              }
            }, false);
            xhr.open('GET', scriptPath);
            xhr.send();
          })(i);
        }
      }

      window.addEventListener('load', function() {
        predownloadScripts();
      })

      function require(moduleName) {
        if (moduleName === 'react') return window.React;
        if (moduleName === 'react-dom') return window.ReactDOM;
        throw new Error("Don't know how to require " + moduleName);
      }
    </script>
  </body>
</html>
